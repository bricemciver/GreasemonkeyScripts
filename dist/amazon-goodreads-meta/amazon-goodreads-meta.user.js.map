{
  "version": 3,
  "sources": ["../../src/main/amazon-goodreads-meta/amazon-goodreads-meta.user.ts"],
  "sourcesContent": ["namespace AmazonGoodreadsMeta {\n  const asinRegex = /^[A-Z0-9]{10}$/\n  const goodreadsRegex = /\"aggregateRating\":({\"@type\":\"AggregateRating\",\"ratingValue\":.*?,\"ratingCount\":.*?,\"reviewCount\":.*?})/\n\n  interface GoodreadsData {\n    rating: string\n    ratingCount: string\n    reviewCount: string\n    bookUrl: string\n  }\n\n  // Extract ASIN from Amazon URL or page\n  const extractASINs = () => {\n    const asins: string[] = []\n    // Check if a multi-book page\n    const books = document.querySelectorAll<HTMLElement>('bds-unified-book-faceout')\n    for (const item of Array.from(books)) {\n      const asin = item.dataset.csaCItemId\n      if (asin && asinRegex.test(asin)) {\n        asins.push(asin)\n      }\n    }\n\n    // Try to extract from page meta data\n    const asinMeta = document.querySelector<HTMLDivElement>('div[data-asin]')\n    if (asinMeta) {\n      const asin = asinMeta.dataset.asin\n      if (asin && asinRegex.test(asin)) {\n        asins.push(asin)\n      }\n    }\n\n    return asins\n  }\n\n  const fetchGoodreadsDataForASIN = (asin: string) => {\n    return GM.xmlHttpRequest({\n      method: 'GET',\n      url: `https://www.goodreads.com/book/isbn/${asin}`,\n    })\n  }\n\n  // Insert Goodreads data into the Amazon page\n  const insertGoodreadsData = (asin: string, goodreadsData: GoodreadsData) => {\n    // Create a styled container for Goodreads data\n    const container = document.createElement('div')\n    container.style.padding = '6px'\n    container.style.margin = '5px 0'\n    container.style.backgroundColor = '#f8f8f8'\n    container.style.border = '1px solid #ddd'\n    container.style.borderRadius = '3px'\n\n    // Create content\n    let content = `<div style=\"display: flex; flex-direction: column; gap: 4px; margin-bottom: 2px;\">\n          <span><img src=\"https://www.goodreads.com/favicon.ico\" style=\"width: 16px; height: 16px; margin-right: 3px;\" alt=\"Goodreads\" />\n          <a href=\"${goodreadsData.bookUrl}\" target=\"_blank\" style=\"font-weight: bold;\">Goodreads</a></span>`\n\n    if (goodreadsData.rating) {\n      content += `<span style=\"color: #000\">${goodreadsData.rating} stars</span>`\n    }\n\n    if (goodreadsData.ratingCount) {\n      content += `<span style=\"white-space: nowrap;\">${goodreadsData.ratingCount} ratings</span>`\n    }\n\n    if (goodreadsData.reviewCount) {\n      content += `<span style=\"white-space: nowrap;\">${goodreadsData.reviewCount} reviews</span>`\n    }\n\n    content += '</div>'\n\n    container.innerHTML = content\n\n    // Find insertion point on Amazon page\n    // Check if the page is a multi-book page\n    const currentBooks = document.querySelectorAll<HTMLElement>('bds-unified-book-faceout')\n    for (const book of Array.from(currentBooks)) {\n      // Book info is in the shadow root, so we need to access it\n      const bookInfoDiv = book.shadowRoot?.querySelector<HTMLDivElement>('div[data-csa-c-item-id]')\n      if (bookInfoDiv) {\n        const bookAsin = bookInfoDiv.dataset.csaCItemId\n        if (bookAsin && bookAsin === asin) {\n          // insert as a multi-book\n          const ratings = book.shadowRoot?.querySelector('div.star-rating')\n          if (ratings) {\n            ratings.parentNode?.insertBefore(container, ratings.nextSibling)\n            break\n          }\n        }\n      }\n    }\n    // insert as a single book\n    const reviewElement = document.getElementById('reviewFeatureGroup')\n    if (reviewElement) {\n      reviewElement.parentNode?.insertBefore(container, reviewElement.nextSibling)\n    }\n  }\n\n  const processAsins = async (asins: string[]) => {\n    for (const asin of asins) {\n      try {\n        const goodreadsData = await fetchGoodreadsDataForASIN(asin)\n        const url = goodreadsData.finalUrl\n        const aggregateMatch = goodreadsRegex.exec(goodreadsData.responseText)\n        if (aggregateMatch && aggregateMatch.length > 1) {\n          const aggregateData = JSON.parse(aggregateMatch[1])\n          const aggregateGoodreadsData: GoodreadsData = {\n            rating: aggregateData.ratingValue,\n            ratingCount: aggregateData.ratingCount,\n            reviewCount: aggregateData.reviewCount,\n            bookUrl: url,\n          }\n          insertGoodreadsData(asin, aggregateGoodreadsData)\n        }\n      } catch (error) {\n        console.error('Error fetching Goodreads data:', error)\n      }\n    }\n  }\n\n  // Main function to initialize the script\n  export const init = async () => {\n    const asins = extractASINs()\n    if (!asins || asins.length === 0) {\n      return\n    }\n\n    try {\n      await processAsins(asins)\n    } catch (error) {\n      console.error('Error in Goodreads script:', error)\n    }\n  }\n}\n\nAmazonGoodreadsMeta.init()\n"],
  "mappings": "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",
  "names": ["AmazonGoodreadsMeta"]
}
