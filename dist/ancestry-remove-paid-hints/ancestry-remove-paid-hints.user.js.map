{
  "version": 3,
  "sources": ["../../src/main/ancestry-remove-paid-hints/ancestry-remove-paid-hints.user.ts"],
  "sourcesContent": ["namespace AncestryRemovePaidHints {\n  const familyTreeSources = [62476, 9289, 1030, 1006]\n\n  const handleOfferPage = (db: IDBDatabase, link: Location) => {\n    // extract dbid\n    const dbidRegex = /[?&]dbid=(\\d+)/\n    const dbidMatch = RegExp(dbidRegex).exec(link.href)\n    if (dbidMatch) {\n      const dbid = Number.parseInt(dbidMatch[1], 10)\n      // since we're on the offer page, we know it's paid\n      const getRequest = db.transaction('collections_os', 'readonly').objectStore('collections_os').get(dbid)\n      getRequest.onsuccess = () => {\n        const result = getRequest.result\n        const putOS = db.transaction('collections_os', 'readwrite').objectStore('collections_os')\n        if (result) {\n          putOS.put({\n            dbid,\n            name: result.name,\n            tree: result.tree,\n            paid: true,\n            visible: false,\n          })\n        } else {\n          putOS.put({\n            dbid,\n            name: '',\n            tree: false,\n            paid: true,\n            visible: false,\n          })\n        }\n      }\n    }\n  }\n\n  const initDB = (): Promise<IDBDatabase | Event> =>\n    new Promise((resolve, reject) => {\n      const openRequest = window.indexedDB.open('collections_db', 1)\n\n      // error handler signifies that the database didn't open successfully\n      openRequest.onerror = () => {\n        const errorMessage = `Database failed to open: ${openRequest?.error?.message ?? 'Unknown error'}`\n        console.error(errorMessage)\n        reject(new Error(errorMessage))\n      }\n\n      // success handler signifies that the database opened successfully\n      openRequest.onsuccess = () => {\n        // Store the opened database object in the db variable. This is used a lot below\n        resolve(openRequest.result)\n      }\n\n      // Set up the database tables if this has not already been done\n      openRequest.onupgradeneeded = () => {\n        // Grab a reference to the opened database\n        const tmpDb: IDBDatabase = openRequest.result\n\n        // Create an objectStore in our database to store notes and an auto-incrementing key\n        // An objectStore is similar to a 'table' in a relational database\n        const objectStore = tmpDb.createObjectStore('collections_os', {\n          keyPath: 'dbid',\n        })\n\n        // Define what data items the objectStore will contain\n        objectStore.createIndex('name', 'name', { unique: true })\n        objectStore.createIndex('paid', 'paid', { unique: false })\n        objectStore.createIndex('tree', 'tree', { unique: false })\n        objectStore.createIndex('visible', 'visible', { unique: false })\n\n        console.log('Database setup complete')\n        resolve(tmpDb)\n      }\n    })\n\n  const evalLink = (db: IDBDatabase, link: HTMLAnchorElement): void => {\n    // Make sure link has test\n    const linkText = link.textContent\n    if (linkText) {\n      // Skip review button links\n      if (linkText !== 'Review' && linkText.indexOf('\\t') === -1 && linkText.indexOf('\\n') === -1) {\n        // extract dbid\n        const dbidRegex = /[?&]dbid=(\\d+)/\n        const dbidMatch = RegExp(dbidRegex).exec(link.href)\n        if (dbidMatch) {\n          const dbid = Number.parseInt(dbidMatch[1], 10)\n\n          // see if database has info\n          // start db transaction\n          const getRequest = db.transaction('collections_os', 'readonly').objectStore('collections_os').get(dbid)\n          getRequest.onsuccess = () => {\n            const result = getRequest.result\n            let hide = false\n            // if no result, query link and add data to the database\n            if (!result) {\n              GM.xmlHttpRequest({\n                method: 'GET',\n                url: link.href,\n                onreadystatechange(response) {\n                  if (response.readyState === Tampermonkey.ReadyState.HeadersReceived) {\n                    // HeadersReceived\n                    const location = response.finalUrl\n                    if (location) {\n                      // find out if this is a paid link\n                      const denyRegex = /offers\\/join/\n                      const denyMatch = RegExp(denyRegex).exec(location)\n                      const putOS = db.transaction('collections_os', 'readwrite').objectStore('collections_os')\n                      const isTree = familyTreeSources.indexOf(dbid) !== -1\n                      if (denyMatch) {\n                        // if match, add to paid collection database\n                        putOS.add({\n                          dbid,\n                          name: link.textContent,\n                          paid: true,\n                          visible: false,\n                          tree: isTree,\n                        })\n                        hide = true\n                      } else if (isTree) {\n                        // by default, hide tree results\n                        putOS.add({\n                          dbid,\n                          name: link.textContent,\n                          paid: false,\n                          visible: false,\n                          tree: true,\n                        })\n                        hide = true\n                      } else {\n                        // add to database as a free link so we don't re-query\n                        putOS.add({\n                          dbid,\n                          name: link.textContent,\n                          paid: false,\n                          visible: true,\n                          tree: false,\n                        })\n                      }\n                    }\n                  }\n                },\n              })\n            } else {\n              hide = !result.visible\n            }\n            if (hide) {\n              // remove hint from view\n              const li = link.closest(\"li[role='group']\")\n              const section = link.closest('section')\n              if (li) {\n                li.remove()\n                if (section && section.querySelectorAll(\"li[role='group']\").length === 1) {\n                  section.remove()\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n\n  const scanHints = (db: IDBDatabase, element: Element): void => {\n    // get links\n    const sseLinks = element.querySelectorAll<HTMLAnchorElement>(\"a[href*='sse.dll']\")\n    for (const link of sseLinks) {\n      evalLink(db, link)\n    }\n\n    // remove family tree\n    const familyTreeLinks = element.querySelectorAll<HTMLAnchorElement>(\"a[href*='/family-tree/tree/']\")\n    for (const link of familyTreeLinks) {\n      // remove hint from view\n      const li = link.closest(\"li[role='group']\")\n      const section = link.closest('section')\n      if (li) {\n        li.remove()\n        if (section && section.querySelectorAll(\"li[role='group']\").length === 1) {\n          section.remove()\n        }\n      }\n    }\n  }\n\n  const mutationObserverSetup = (db: IDBDatabase): void => {\n    // Options for the observer (which mutations to observe)\n    const config = { childList: true, subtree: true }\n\n    // Callback function to execute when mutations are observed\n    const callback: MutationCallback = mutationList => {\n      for (const mutation of mutationList) {\n        if (mutation.type === 'childList') {\n          for (const addedNode of mutation.addedNodes) {\n            const element = addedNode as Element\n            if (\n              element.innerHTML &&\n              (element.innerHTML.indexOf('sse.dll') !== -1 || element.innerHTML.indexOf('/family-tree/tree/') !== -1)\n            ) {\n              scanHints(db, element)\n            }\n          }\n        }\n      }\n    }\n\n    // Create an observer instance linked to the callback function\n    const observer = new MutationObserver(callback)\n\n    // Start observing the target node for configured mutations\n    observer.observe(document, config)\n  }\n\n  export const main = async (): Promise<void> => {\n    const db = await initDB()\n    if (db instanceof IDBDatabase) {\n      // see if we're on offer page and handle it\n      if (window.location.href.indexOf('offers/join') !== -1) {\n        handleOfferPage(db, window.location)\n      } else {\n        mutationObserverSetup(db)\n      }\n    }\n  }\n}\nAncestryRemovePaidHints.main()\n"],
  "mappings": "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",
  "names": ["AncestryRemovePaidHints"]
}
