{
  "version": 3,
  "sources": ["../../src/main/ancestry-remove-paid-hints/ancestry-remove-paid-hints.user.ts"],
  "sourcesContent": ["const familyTreeSources = [62476, 9289, 1030, 1006];\n\nconst handleOfferPage = (db: IDBDatabase, link: Location) => {\n  // extract dbid\n  const dbidRegex = /[?&]dbid=(\\d+)/;\n  const dbidMatch = RegExp(dbidRegex).exec(link.href);\n  if (dbidMatch) {\n    const dbid = parseInt(dbidMatch[1], 10);\n    // since we're on the offer page, we know it's paid\n    const getRequest = db.transaction('collections_os', 'readonly').objectStore('collections_os').get(dbid);\n    getRequest.onsuccess = event => {\n      const target = event.target;\n      if (target) {\n        const result = (target as any).result;\n        const putOS = db.transaction('collections_os', 'readwrite').objectStore('collections_os');\n        if (result) {\n          putOS.put({ dbid, name: result.name, tree: result.tree, paid: true, visible: false });\n        } else {\n          putOS.put({ dbid, name: '', tree: false, paid: true, visible: false });\n        }\n      }\n    };\n  }\n};\n\nconst initDB = (): Promise<IDBDatabase | Event> =>\n  new Promise((resolve, reject) => {\n    const openRequest = window.indexedDB.open('collections_db', 1);\n\n    // error handler signifies that the database didn't open successfully\n    openRequest.onerror = event => {\n      console.error('Database failed to open');\n      reject(event);\n    };\n\n    // success handler signifies that the database opened successfully\n    openRequest.onsuccess = _event => {\n      // Store the opened database object in the db variable. This is used a lot below\n      resolve(openRequest.result);\n    };\n\n    // Set up the database tables if this has not already been done\n    openRequest.onupgradeneeded = event => {\n      // Grab a reference to the opened database\n      const eventTarget = event.target;\n      if (eventTarget) {\n        const tmpDb: IDBDatabase = (eventTarget as any).result;\n\n        // Create an objectStore in our database to store notes and an auto-incrementing key\n        // An objectStore is similar to a 'table' in a relational database\n        const objectStore = tmpDb.createObjectStore('collections_os', {\n          keyPath: 'dbid',\n        });\n\n        // Define what data items the objectStore will contain\n        objectStore.createIndex('name', 'name', { unique: true });\n        objectStore.createIndex('paid', 'paid', { unique: false });\n        objectStore.createIndex('tree', 'tree', { unique: false });\n        objectStore.createIndex('visible', 'visible', { unique: false });\n\n        // eslint-disable-next-line no-console\n        console.log('Database setup complete');\n        resolve(tmpDb);\n      }\n    };\n  });\n\nconst evalLink = (db: IDBDatabase, link: HTMLAnchorElement): void => {\n  // Make sure link has test\n  const linkText = link.textContent;\n  if (linkText) {\n    // Skip review button links\n    if (linkText !== 'Review' && linkText.indexOf('\\t') === -1 && linkText.indexOf('\\n') === -1) {\n      // extract dbid\n      const dbidRegex = /[?&]dbid=(\\d+)/;\n      const dbidMatch = RegExp(dbidRegex).exec(link.href);\n      if (dbidMatch) {\n        const dbid = parseInt(dbidMatch[1], 10);\n\n        // see if database has info\n        // start db transaction\n        const getRequest = db.transaction('collections_os', 'readonly').objectStore('collections_os').get(dbid);\n        getRequest.onsuccess = event => {\n          const target = event.target;\n          if (target) {\n            const result = (target as any).result;\n            let hide = false;\n            // if no result, query link and add data to the database\n            if (!result) {\n              GM.xmlHttpRequest({\n                method: 'GET',\n                url: link.href,\n                onreadystatechange(response) {\n                  if (response.readyState === Tampermonkey.ReadyState.HeadersReceived) {\n                    // HeadersReceived\n                    const location = response.finalUrl;\n                    if (location) {\n                      // find out if this is a paid link\n                      const denyRegex = /offers\\/join/;\n                      const denyMatch = RegExp(denyRegex).exec(location);\n                      const putOS = db.transaction('collections_os', 'readwrite').objectStore('collections_os');\n                      const isTree = familyTreeSources.indexOf(dbid) !== -1;\n                      if (denyMatch) {\n                        // if match, add to paid collection database\n                        putOS.add({ dbid, name: link.textContent, paid: true, visible: false, tree: isTree });\n                        hide = true;\n                      } else if (isTree) {\n                        // by default, hide tree results\n                        putOS.add({ dbid, name: link.textContent, paid: false, visible: false, tree: true });\n                        hide = true;\n                      } else {\n                        // add to database as a free link so we don't re-query\n                        putOS.add({ dbid, name: link.textContent, paid: false, visible: true, tree: false });\n                      }\n                    }\n                  }\n                },\n              });\n            } else {\n              hide = !result.visible;\n            }\n            if (hide) {\n              // remove hint from view\n              const li = link.closest(\"li[role='group']\");\n              const section = link.closest('section');\n              if (li) {\n                li.remove();\n                if (section && section.querySelectorAll(\"li[role='group']\").length === 1) {\n                  section.remove();\n                }\n              }\n            }\n          }\n        };\n      }\n    }\n  }\n};\n\nconst scanHints = (db: IDBDatabase, element: Element): void => {\n  // get links\n  const sseLinks = element.querySelectorAll<HTMLAnchorElement>(\"a[href*='sse.dll']\");\n  sseLinks.forEach(link => evalLink(db, link));\n\n  // remove family tree\n  const familyTreeLinks = element.querySelectorAll<HTMLAnchorElement>(\"a[href*='/family-tree/tree/']\");\n  familyTreeLinks.forEach(link => {\n    // remove hint from view\n    const li = link.closest(\"li[role='group']\");\n    const section = link.closest('section');\n    if (li) {\n      li.remove();\n      if (section && section.querySelectorAll(\"li[role='group']\").length === 1) {\n        section.remove();\n      }\n    }\n  });\n};\n\nconst mutationObserverSetup = (db: IDBDatabase): void => {\n  // Options for the observer (which mutations to observe)\n  const config = { childList: true, subtree: true };\n\n  // Callback function to execute when mutations are observed\n  const callback: MutationCallback = (mutationList, _observer) => {\n    for (const mutation of mutationList) {\n      if (mutation.type === 'childList') {\n        mutation.addedNodes.forEach(node => {\n          const element = node as Element;\n          if (\n            element.innerHTML &&\n            (element.innerHTML.indexOf('sse.dll') !== -1 || element.innerHTML.indexOf('/family-tree/tree/') !== -1)\n          ) {\n            scanHints(db, element);\n          }\n        });\n      }\n    }\n  };\n\n  // Create an observer instance linked to the callback function\n  const observer = new MutationObserver(callback);\n\n  // Start observing the target node for configured mutations\n  observer.observe(document, config);\n};\n\nconst main = async (): Promise<void> => {\n  const db = await initDB();\n  if (db instanceof IDBDatabase) {\n    // see if we're on offer page and handle it\n    if (window.location.href.indexOf('offers/join') !== -1) {\n      handleOfferPage(db, window.location);\n    } else {\n      mutationObserverSetup(db);\n    }\n  }\n};\n\nmain().catch(_error => ({}));\n"],
  "mappings": "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",
  "names": []
}
